<!DOCTYPE html>
<html>
  <head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js" integrity="sha512-L5K9Bf852XyB+wrvRFGwWzfhVI+TZqJlgwzX9yvrfhILuzIZfrcQO4au9D9eVDnkQ6oqYr9v2QwJdFo+eKE50Q==" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q==" crossorigin=""></script>
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/leaflet.markercluster@1.0.3/dist/leaflet.markercluster.js"></script>

  <script>
    function onLoadFunc()
    {
      document.getElementById('start').disabled = true;
    }
     function initGeolocation()
     {
        if( navigator.geolocation )
        {
           // Call getCurrentPosition with success and failure callbacks
           navigator.geolocation.getCurrentPosition( success, fail );
        }
        else
        {
           alert("Sorry, your browser does not support geolocation services.");
        }
     }
     function success(position)
     {
         document.getElementById('long').value = position.coords.longitude;
         document.getElementById('lat').value = position.coords.latitude;
         document.getElementById('start').disabled = false;
         document.getElementById('start').style.background-color = '#C0C0C0';
     }

     function fail()
     {
        // Could not obtain location
     }


      var i = 1;

     function startFunc() {
       setTimeout(function() {
         document.getElementById("bikelist").innerHTML = "";
         bikeFinder();
         i++;
         if (i < 180) {
           startFunc();
         }
       }, 5000)
     }

     function bikeFinder()
     {
       let requestURL = 'https://gbfs.divvybikes.com/gbfs/en/free_bike_status.json';
       var rad = document.getElementById('radius').value;
       d3.json(requestURL).then(function(divvyData) {
         var tbody = d3.select("tbody");
         var allBikes = divvyData.data
         var bikearray = allBikes.bikes;
           const bikes = bikearray.filter(d => Math.abs(d.lon - document.getElementById('long').value) < (rad / 364300) && Math.abs(d.lat - document.getElementById('lat').value) < (rad / 364300));
           document.getElementById("bikelist").innerHTML = bikes.length
          if (bikes.length > 0) {
            document.getElementById("bikelist").style.color = "green";
            var soundBox = document.getElementById("sound");
            var alertBox = document.getElementById("alert");
            if (soundBox.checked == true) {
            var beepsound = new Audio('https://orangefreesounds.com/wp-content/uploads/2016/02/Bike-ring-bell.mp3');
              beepsound.play(); }
            if (alertBox.checked == true) {
              alert("A bike has been found!");
            }
          } else {
             document.getElementById("bikelist").style.color = "red";
           }
         })
     }

   </script>
   <style>
   input[type=button] {
     width: 20%;
     color: black;
     background-color: #C6F3FF;
     padding: 14px 20px;
     margin: 8px 0;
     border-color: black;
     border-radius: 4px;
     cursor: pointer;
     font-size: 20px;
   }
   #long, #lat {
     width: 20%;
     padding: 12px 20px;
     margin: 8px 0;
     display: inline-block;
     border: 1px solid #ccc;
     border-radius: 4px;
     box-sizing: border-box;
    }
    #radius {
      width: 20%;
      padding: 12px 20px;
      margin: 8px 0;
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
     }
     p {
       font-size: 25px;
       font-family: Arial;
     }
     h2 {
       font-family: Arial;
     }
   </style>
 </head>

 <body onload="onLoadFunc()">
    <FORM NAME="rd" METHOD="POST" ACTION="index.html">
      <INPUT TYPE="button" NAME="locate" ID="locate" VALUE="Get Location" onClick="initGeolocation();">
      <INPUT TYPE="text" NAME="long" ID="long" VALUE="">
      <INPUT TYPE="text" NAME="lat" ID="lat" VALUE="">
      <p>Radius (in ft | default = 1000): <INPUT TYPE="text" NAME="radius" ID="radius" VALUE="1000"></p>
      <p> Play Sound? <INPUT TYPE="checkbox" ID="sound"> </p>
      <p> Show Alert? <INPUT TYPE="checkbox" ID="alert"> </p>
      <br>
      <INPUT TYPE="button" NAME="start" ID="start" VALUE="Start" onClick="startFunc();" onl>
      </FORM>
      <br>
      <h2> Nearby Bikes: <div ID="bikelist"></div></h2>
 </body>
</html>
